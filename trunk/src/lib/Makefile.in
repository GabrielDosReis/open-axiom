# Copyright (C) 2007-2008, Gabriel Dos Reis.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#
#     - Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#
#     - Redistributions in binary form must reproduce the above copyright
#       notice, this list of conditions and the following disclaimer in
#       the documentation and/or other materials provided with the
#       distribution.
#
#     - Neither the name of The Numerical Algorithms Group Ltd. nor the
#       names of its contributors may be used to endorse or promote products
#       derived from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
# IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
# PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER
# OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.



core_SOURCES = bsdsignal.c cfuns-c.c sockio-c.c
terminal_io_SOURCES = cursor.c edin.c fnct_key.c openpty.c prt.c wct.c
graphics_SOURCES = \
		halloc.c \
		hash.c \
		pixmap.c \
		spadcolors.c \
		util.c \
		XDither.c \
		XShade.c \
		XSpadFill.c

libspad_la_SOURCES = $(foreach comp, \
			 $(addsuffix _SOURCES, @axiom_c_runtime@), \
			 $($(comp)))

unused_SOURCES = emupty.c

libopen_axiom_core_la_SOURCES = $(core_SOURCES)
libopen_axiom_core_la_objects = $(libopen_axiom_core_la_SOURCES:.c=.lo)
libspad_la_objects = $(libspad_la_SOURCES:.c=.lo)

subdir = src/lib/

.PHONY: all all-lib
.SUFFIXES:
.SUFFIXES: .o .lo .obj .c .h

all: all-ax

all-ax all-lib: stamp
stamp: $(axiom_target_libdir)/libopen-axiom-core.$(DLLEXT) \
	$(axiom_target_libdir)/libspad.la
	rm -f stamp
	$(STAMP) stamp

$(axiom_target_libdir)/libopen-axiom-core.$(DLLEXT): \
	$(libopen_axiom_core_la_objects)
	$(mkinstalldirs) $(axiom_target_libdir)
	$(LIBTOOL) --mode=link $(CC) -shared -o $@ \
		$(libopen_axiom_core_la_objects) @axiom_c_runtime_extra@ \
		-rpath "$(libdir)"/axiom/target/$(target)/lib

$(axiom_target_libdir)/libspad.la: $(libspad_la_objects)
	$(mkinstalldirs) $(axiom_target_libdir)
	$(LIBTOOL) --mode=link $(CC) -o $@ $(libspad_la_objects) \
		-rpath "$(libdir)"/axiom/target/$(target)/lib

.PRECIOUS: %.$(OBJEXT) %.lo

%.lo: %.c $(axiom_c_macros_h)
	$(COMPILE) -o $@ $(CCF) -DOPENAXIOM_BUILD_DLL \
		$(axiom_includes) $(AXIOM_X11_CFLAGS) $<

# This is a support library, so it does not change often and
# we don't need to remove the produced objects in mostlyclean.
# The remoal is done by clean.
mostlyclean-local:
	@rm -f *.lo *.$(OBJEXT)

clean-local: mostlyclean-local
	@$(LIBTOOL) --mode=clean $(axiom_target_libdir)/libopen-axiom-core.$(DLLEXT)
	@$(LIBTOOL) --mode=clean $(axiom_target_libdir)/libspad.la
	@rm -f $(other_objects)
	@rm -fr .libs _libs
	@rm -f stamp

distclean-local: clean-local
